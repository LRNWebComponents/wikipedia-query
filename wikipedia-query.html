<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../hax-body-behaviors/hax-body-behaviors.html">
<!--
`wikipedia-query`
A LRN element

@demo demo/index.html
-->

<dom-module id="wikipedia-query">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <h2>Results for {{search}}</h2>
    <div>
    <div id="result"></div>
    </div>
    <iron-ajax
       auto
       url$="https://en.wikipedia.org/w/api.php?origin=*&action=query&titles={{search}}&prop=extracts&format=json"
       handle-as="json"
       on-response="handleResponse"
       last-response="{{searchResponse}}"></iron-ajax>
  </template>
  <script>
    Polymer({

      is: 'wikipedia-query',
      behaviors: [HAXBehaviors.PropertiesBehaviors],
      properties: {
        /**
         * Search string.
         */
        search: {
          type: String,
          value: 'Polymer (library)',
          reflectToAttribute: true,
        },
        /**
         * Response to parse.
         */
        searchResponse: {
          type: Object,
        },
      },
      /**
       * Ready
       */
      ready: function() {
        // Establish hax properties if they exist
        let props = {
          'canScale': true,
          'canPosition': true,
          'settings': {
            'bar':[
              {
                'property': 'search',
                'title': 'Search term',
                'description': 'Word to search wikipedia for.',
                'inputMethod': 'textfield',
                'icon': 'title',
                'required': true,
              }
            ]
          }
        };
        this.setHaxProperties(props);
      },
      /**
       * Process response from wikipedia.
       */
      handleResponse: function(response) {
        // the key of pages is a number so need to look for it
        for (var key in this.searchResponse.query.pages) {
          // skip anything that's prototype object
          if (!this.searchResponse.query.pages.hasOwnProperty(key)) continue;
          // load object response
          var obj = this.searchResponse.query.pages[key];
          // need to innerHTML this or it won't set
          this.$.result.innerHTML = obj.extract;
        }
      }
    });
  </script>
</dom-module>
